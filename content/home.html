<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ribbit - Home</title>
<link rel="stylesheet" href="/content/style.css">
</head>
<body>

<div class="top-box">
  <div>Ribbit - Chatting like the old days</div>
  <a href="/logout">Logout</a>
</div>

<div class="main-content">

  <!-- Friends List -->
  <div class="left">
    <h2>Friends</h2>
    <input type="text" id="friendSearch" placeholder="Search users...">
    <ul id="searchResults"></ul>
    <ul id="friendsList"></ul>
  </div>

  <!-- Posts / DMs -->
  <div class="middle">
    <h2 id="postsHeader">Posts</h2>
    <div id="posts"></div>

    <form id="postForm" class="post-form-inline" enctype="multipart/form-data">
      <input type="text" id="postInput" placeholder="Write a message..." required>
      <input type="file" id="postImage" accept="image/*" style="display:none;">
      <label for="postImage" class="image-icon">üì∑</label>
      <button type="submit">Send</button>
    </form>
  </div>

  <!-- Settings -->
  <div class="right">
    <h2>Settings</h2>
    <p>Profile</p>
    <p>Notifications</p>
    <p>Privacy</p>
  </div>

</div>

<footer>¬© 2025 Ribbit</footer>

<script src="/content/friends.js"></script>

<script>
window.currentFriend = null;  // make currentFriend global
let currentUser = null;

// Get logged-in username
async function getUsername() {
  try {
    const res = await fetch('/me', { credentials: 'same-origin' });
    if (!res.ok) throw new Error('Not logged in');
    const data = await res.json();
    currentUser = data.username;
    return data.username;
  } catch {
    window.location.href = '/index.html';
  }
}

// Load posts or DMs
async function loadPosts() {
  const postsDiv = document.getElementById('posts');
  postsDiv.innerHTML = '';

  let url = '/posts';
  if (window.currentFriend) {
    url = `/dm?user=${encodeURIComponent(window.currentFriend)}`;
    document.getElementById('postsHeader').textContent = `DM with ${window.currentFriend}`;
  } else {
    document.getElementById('postsHeader').textContent = 'Posts';
  }

  const res = await fetch(url, { credentials: 'same-origin' });
  const data = await res.json();

  data.forEach(p => {
    const post = document.createElement('div');
    post.className = 'post';
    
    if (window.currentFriend) {
      // DM posts: message + optional image
      post.innerHTML = `<strong>${p.username}</strong><br>
                        ${p.message || ''}
                        ${p.image ? `<br><img src="${p.image}" class="post-img">` : ''}`;
    } else {
      // Public posts: message + image + likes/comments
      post.innerHTML = `
        <strong>${p.username}</strong><br>
        ${p.message || ''}
        ${p.image ? `<br><img src="${p.image}" class="post-img">` : ''}
        <div class="actions">
          <button class="like-btn" data-id="${p.id}">‚ù§Ô∏è ${p.likes?.length || 0}</button>
          <button class="comment-toggle" data-id="${p.id}">üí¨ Comment</button>
        </div>
        <div class="comments" id="comments-${p.id}">
          ${(p.comments || []).map(c => `<p><b>${c.user}:</b> ${c.text}</p>`).join('')}
          <input type="text" placeholder="Write a comment..." class="comment-input" data-id="${p.id}">
        </div>
      `;
    }
    postsDiv.appendChild(post);
  });

  // Only add likes/comments for public posts
  if (!window.currentFriend) {
    document.querySelectorAll('.like-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const postId = btn.dataset.id;
        await fetch('/like', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ postId })
        });
        loadPosts();
      });
    });

    document.querySelectorAll('.comment-input').forEach(input => {
      input.addEventListener('keypress', async e => {
        if (e.key === 'Enter') {
          const text = e.target.value.trim();
          if (!text) return;
          const postId = e.target.dataset.id;
          await fetch('/comment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ postId, text })
          });
          e.target.value = '';
          loadPosts();
        }
      });
    });
  }

  postsDiv.scrollTop = postsDiv.scrollHeight;
}

// Handle new posts / DMs
document.getElementById('postForm').addEventListener('submit', async e => {
  e.preventDefault();

  const message = document.getElementById('postInput').value.trim();
  const imageFile = document.getElementById('postImage').files[0];

  if (!message && !imageFile) return;

  const formData = new FormData();
  formData.append('message', message);
  if (imageFile) formData.append('image', imageFile);
  if (window.currentFriend) formData.append('friend', window.currentFriend);

  const endpoint = window.currentFriend ? '/dm' : '/posts';

  await fetch(endpoint, {
    method: 'POST',
    credentials: 'same-origin',
    body: formData
  });

  document.getElementById('postForm').reset();
  loadPosts();
});

// Initialize
(async function init() {
  await getUsername();
  loadPosts();
  loadFriends(); // from friends.js
  setInterval(loadPosts, 5000);
  setInterval(checkFriendRequests, 5000);
})();
</script>

</body>
</html>

